{% extends "layout.html" %}
{% block content %}
<h1 class="h3 mb-3">Пользователи</h1>
<div class="card mb-4">
    <div class="card-header">Добавить пользователя</div>
    <div class="card-body">
        <form method="post" action="/api/users" class="row g-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="action" value="create">
            <div class="col-md-4"><label class="form-label">Имя</label><input type="text" name="name" class="form-control" required></div>
            <div class="col-md-4"><label class="form-label">Телефон</label><input type="text" name="phone" class="form-control" required></div>
            <div class="col-md-3">
                <label class="form-label">Роль</label>
                <select name="role" class="form-select">
                    {% if user.role == 'admin' %}<option value="admin">Администратор</option>{% endif %}
                    <option value="manager">Менеджер</option>
                    <option value="guard">Охранник</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-plus-lg"></i></button></div>
        </form>
    </div>
</div>
<div class="card">
    <div class="card-header">Список пользователей</div>
    <div class="card-body table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead><tr><th>Имя</th><th>Телефон</th><th>Роль</th><th>Статус</th><th class="text-end">Действия</th></tr></thead>
            <tbody>
                {% for row in users %}
                <tr>
                    <td>{{ row.name }}</td>
                    <td>{{ row.phone }}</td>
                    <td><span class="badge text-bg-light badge-role">{{ role_label(row.role) }}</span></td>
                    <td>{% if row.status == 'active' %}<span class="badge text-bg-success">Активен</span>{% else %}<span class="badge text-bg-secondary">Заблокирован</span>{% endif %}</td>
                    <td class="text-end">
                        <form id="toggle-{{ row.id }}" method="post" action="/api/users" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="toggle_status">
                            <input type="hidden" name="user_id" value="{{ row.id }}">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#statusModal" data-confirm="statusModal" data-form="toggle-{{ row.id }}">
                                <i class="bi bi-shield"></i> {{ 'Заблокировать' if row.status == 'active' else 'Разблокировать' }}
                            </button>
                        </form>
                        {% if row.id != user.id %}
                        <form id="delete-{{ row.id }}" method="post" action="/api/users" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="user_id" value="{{ row.id }}">
                            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal" data-confirm="deleteModal" data-form="delete-{{ row.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Подтвердите действие</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Изменить статус пользователя?</div><div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button><button type="button" class="btn btn-primary" data-confirm-submit>Подтвердить</button></div></div></div></div>
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Удаление пользователя</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Вы действительно хотите удалить пользователя?</div><div class="modal-footer"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button><button type="button" class="btn btn-danger" data-confirm-submit>Удалить</button></div></div></div></div>
{% endblock %}
